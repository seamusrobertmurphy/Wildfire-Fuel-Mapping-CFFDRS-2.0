---
title: "Proof of Concept:"
subtitle: "CFFDRS Wildfire Fuel Mapping Prototype"
author: "CabinGIS"
date: "24/02/2022"
output: 
  pdf_document:
    toc: TRUE
    toc_depth: 5
    number_sections: TRUE
    df_print: tibble
    latex_engine: xelatex
  zotero: TRUE

bibliography: references.bib
---

```{r setup, echo=FALSE, message=FALSE,warning=FALSE, error=FALSE}
library(lidR)
library(mapview)
library(rgl)
library(pandocfilters)
library(rmarkdown)
library(formatR)
library(gitignore)
library(tinytex)
library(knitr)
library(raster)
library(webdriver)
library(webshot)
library(webshot2)
library(RColorBrewer)
library(conflicted)
library(readr)
library(tibble)
library(sf)
library(dplyr)
library(raster)
library(terra)
library(rgdal)
library(cffdrs)
library(ncdf4)
#webshot::install_phantomjs(force = TRUE)
knit_hooks$set(webgl = hook_webgl)
knit_hooks$set(rgl.static = hook_rgl)
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, error=FALSE, message = FALSE)
set.seed(23)
```

## Action {.unnumbered}

Building on the momentum and ideas of our last meeting, the following pipeline was drafted to produce the wildfire fuel mapping outputs that are described in the NRC grant "High-Resolution Mapping":

-   NRC Grant: <https://www.ic.gc.ca/eic/site/101.nsf/eng/00157.html>

#### *fwiRaster and sdmc calculated based on daily climate records*

#### *gfmc and hffmc calculated based on hourly climate records - key to CFFDRSv2.0*

#### *Start date of fire season calculated with fireSeason*

#### *All outputs generated for once-daily calcuylations for the full fireSeason chronologically using 'batch=TRUE' function*

Using the new [cffdrs R-package](https://cran.r-project.org/web/packages/cffdrs/cffdrs.pdf), which was designed specifically for the purpose of the Canadian Forest Fire Danger Rating System (\@wang2017cffdrs) and was based on the methods of Van Wagner (\@van1987development), we were able to derive raster maps of fuel moisture content indices for five wildfire fuel indices and three wildfire wildfire weather and fuel behaviour indices.

Two of these stand-based fuel moisture rasters, FFMC and DMC, were used to fit Wotton and Beverly's model of stand-adjusted fine fuel moisture content (\@wotton2007stand). This seems to be the 'go-to' in BC model for providing vegetation and forest fuel maps needed in the CFFDRSv2.0.

+---------------------------------------+-------+---+--------------------------------+-----------+
| Phase 1: Fuel Type Mapping            |       |   | Phase 2: Fuel Moisture Mapping |           |
+=======================================+=======+===+================================+===========+
| **CFFDRS Fuel Class**                 | Label |   | **Index**                      | **Label** |
+---------------------------------------+-------+---+--------------------------------+-----------+
| Spruce-Lichen Woodland                | C-1   |   | Fine Fuel Moisture Code        | FFMC      |
+---------------------------------------+-------+---+--------------------------------+-----------+
| Boreal Spruce                         | C-2   |   | Duff Moisture Code             | DMC       |
+---------------------------------------+-------+---+--------------------------------+-----------+
| Mature Jack or Lodgepole Pine         | C-3   |   | Grass Fuel Moisture Code       | GFMC      |
+---------------------------------------+-------+---+--------------------------------+-----------+
| Immature Jack or Lodgepol Pine        | C-4   |   | Sheltered Duff Code            | SDC       |
+---------------------------------------+-------+---+--------------------------------+-----------+
| Red and White Pine                    | C-5   |   | Drought Code                   | DC        |
+---------------------------------------+-------+---+--------------------------------+-----------+
| Conifer Plantation                    | C-6   |   | Build-Up Index                 | BUI       |
+---------------------------------------+-------+---+--------------------------------+-----------+
| Ponderosa Pine                        | C-7   |   | Fire Weather Index             | FWI       |
+---------------------------------------+-------+---+--------------------------------+-----------+
| Leafless Aspen                        | D-1   |   | Danger Severity Rating         | DSR       |
+---------------------------------------+-------+---+--------------------------------+-----------+
| Boreal Mixedwood - Leafless           | M-1   |   |                                |           |
+---------------------------------------+-------+---+--------------------------------+-----------+
| Boreal Mixedwood - Green              | M-2   |   |                                |           |
+---------------------------------------+-------+---+--------------------------------+-----------+
| Dead Balsam Fir/ Mixedwood - Leafless | M-3   |   |                                |           |
+---------------------------------------+-------+---+--------------------------------+-----------+
| Dead Balsam Fir/ Mixedwood - Green    | M-4   |   |                                |           |
+---------------------------------------+-------+---+--------------------------------+-----------+
| Jack or Lodgepole Pine Slash          | S-1   |   |                                |           |
+---------------------------------------+-------+---+--------------------------------+-----------+
| Spruce/Balsam Slash                   | S-2   |   |                                |           |
+---------------------------------------+-------+---+--------------------------------+-----------+
| Coastal Cedar/Hemlock/Douglas-f Slash | S-3   |   |                                |           |
+---------------------------------------+-------+---+--------------------------------+-----------+
| Matted Grass                          | O-1a  |   |                                |           |
+---------------------------------------+-------+---+--------------------------------+-----------+
| Standing Grass                        | O-1b  |   |                                |           |
+---------------------------------------+-------+---+--------------------------------+-----------+

# BC WildFire Fuel Typing VRI-Layer Algorithm

The FLNRO 2015 paper provides a really user-friendly screening algorithm of that is design with a hierachy of criteria suited for filtering or subsetting spatial objects in R (although Arc-built). For this, we imported the VRI dataset as a shapefile.shp from the manually downloaded imapBC files and transformed it into a simple feature object and processed it according to the fuel-type criteria checklist using sf, dplyr and terra functions. (*TODO: draft 'spatialPolygonDataFrame' pipeline for any potential future software compatibility issues.*)

If its the former, there is some useful info found in the cffdrs package that describe the data requirements of the FWI System There is also a FWI test dataset 'test_fwi' showing the format of these inputs that is presented below. In the pilot test below, we generated the five raster predictors that are required inputs in the Wotton standjust CFFDRS model. These rasters were derived for the Peachland watershed area for the 2021 fire season period up until June 30th of that year.

```{r}
library(cffdrs)
print(as_tibble(test_fwi), n = 10)
```

However, if its the second, and they are wanting a deliverable that is purely fuel-type focused, it may be worth having at look at and following closely the 'FLNRO 2015 BC Fuel-Typing and VRI-Layering Framework' (\@perrakis2018british). In it, they've developed an Arc-Python based algorithm that filters the VRI dataset using a kind of multi-criteria classification key to delineate landscapes into polygons according to the 16 Canadian Standard Fuel Type classes (\@hirsch1996canadian). In the final section below, we made a rough attempt of fitting this algorithm and coding the 100-plus VRI-criteria-layers (only got to 23) to generate similar fuel-type rasters. This report, its scripts and its virtual environment are stored in the github repo here: <https://github.com/seamusrobertmurphy/Wildfire-Fuel-Mapping-CFFDRS-2.0>.

# Stand-Adjusted CFFDRS Fuel Typing Model

Five spatial predictor variables are needed to fit the Wotton and Beverly stand-adjusted fuel typing model (\@wotton2007stand) : "FFMC, DMC, stand (1:5; deciduous, Douglas-fir, mixedwood, pine, spruce), density (1:3; light, mod, dense), season (1, 1.5, 2, 3; spring, spr-sum transition, sum, fall). Two of these predictors, including density and stand were extracted from VRI-layers as simpleFeatures objects and then rasterized and stacked using the terra and raster packages.

```{r, fig.show='hold', out.width="50%"}
library(ggplot2)
watershed_bdrys = read_sf("./Data/BCGW_7113060B_1645786298548_3276/LWADM_WATMGMT_PREC_AREA_SVW/LWADM_PA_polygon.shp")
peachland = watershed_bdrys[watershed_bdrys$PRECNC_NAM == "Peachland", ]
vri_sf = read_sf("./Data/BCGW_7113060B_1645786298548_3276/VEG_COMP_LYR_R1_POLY/VEG_R1_PLY_polygon.shp")
vri_sf = st_intersection(st_make_valid(vri_sf), peachland)

stand = vri_sf["SPEC_CD_1"] %>%
  mutate(SPEC_CD_1 = as.factor(SPEC_CD_1))
stand = rename(stand, stand = SPEC_CD_1)
summary.factor(stand$stand)

density = vri_sf["LIVE_STEMS"] %>%
  mutate(LIVE_STEMS = as.numeric(LIVE_STEMS))
density = rename(density, density = LIVE_STEMS)
summary(density)

ggplot(stand) + geom_sf(aes(fill=stand), size = 0.05)
ggplot(density) + geom_sf(aes(fill=density), size = 0.0005) + scale_fill_viridis_c()
```

To derive FFMC and DMC rasters we needed to process four climatic rasters representing mean daily conditions since the start of fire season (first day of mean daily temperature above 12C) to June 30th for: 1) mean daily temperature at 2m, 2) mean daily precipitation, 3) mean relative humidity, 4) and mean wind speed at 10m. Climatic rasters were download as NetCDF files from NASA Power platform and imported directly as rasters from their .nc extensive format. The NASA Power platform also provides nice, user-friendly API data source links that would be ideal for this kind of software and grant deliverable

-   NASA Power Platform: <https://power.larc.nasa.gov/data-access-viewer/>

```{r, fig.show='hold', out.width="50%"}
temp = raster::raster("./Data/temp.nc")
prec = raster::raster("./Data/prec.nc")
rh = raster::raster("./Data/rh.nc")
ws = raster::raster("./Data/ws.nc")

names(temp) = 'temp'
names(prec) = 'prec'
names(rh) = 'rh'
names(ws) = 'ws'

plot(temp)
plot(prec)
plot(rh)
plot(ws)
```

Interpolated climate predictors were assembled as a raster stack and inputted to the fwiRaster function in the cffdrs package. 'out="all'" was selected to produce raster outputs for the three FWI fuel moisture indices of Fine Fuel Moisture Code (FFMC), Duff Moisture Code (DMC), Drought Code (DC), as well as raster outputs for Initial Spread Index (isi), Build-up Index (bui), Fire Weather Index (fwi), and Danger Severity Rating (dsr).

```{r}
stack = stack(temp, rh, ws, prec)
fwi_outputs = fwiRaster(stack, out = "all")
plot(fwi_outputs)
ffmc = raster(fwi_outputs, layer=5)
dmc = raster(fwi_outputs, layer=6)
dc = raster(fwi_outputs, layer=7)
isi = raster(fwi_outputs, layer=8)
bui = raster(fwi_outputs, layer=9)
fwi = raster(fwi_outputs, layer=10)
dsr = raster(fwi_outputs, layer=11)
```

```{r, eval=FALSE}
fields::stats(vri_sf$HRVSTDT)
fields::stats(vri_sf$C_I_CODE)
fields::stats(vri_sf$BEC_ZONE)

#fuel_algo = dplyr::filter(vri_sf, HRVSTDT == NA | HRVSTDT < 2016)
vri_harvest = vri_sf["HRVSTDT"]
wildfire_sf = wildfire_sf["FIRE_YEAR"]
wildfire_aoi = wildfire_sf$FIRE_YEAR > 2000
wildfire_aoi = st_intersection(st_make_valid(wildfire_sf), aoi_sf)
vri_species_aoi = st_intersection(st_make_valid(vri_species), aoi_sf)
vri_species_aoi$SPEC_CD_1 = as.factor(vri_species_aoi$SPEC_CD_1)
vri_species_aoi =  dplyr::filter(vri_species_aoi, SPEC_CD_1 == "PL" | SPEC_CD_1 == "SB" | SPEC_CD_1 == "SE" )


```

*TODO: Finish dataframe pipeline below for less buggy inputs with shiny app deploys.*

Send to Appendix: Following chunk includes functions for developing dataframe inputs in case of likely software compatability issues.

```{r, eval=FALSE}
climate_vars = read.csv("./Data/power_nasa_kelowna.csv")
climate_vars_sf = st_as_sf(climate_vars, coords = c("LAT", "LON"), crs = 4326)
raster_template = raster(xmn=49.25, xmx=51.25, ymn=-122.25, ymx=-116.25, res=20, crs = "EPSG:3153")
temp = climate_vars_sf["T2M"]
temp = dplyr::rename(temp, temp = T2M)
temp = rasterize(temp, raster_template, res=20)
rh = climate_vars_sf["RH2M"]
rh = dplyr::rename(rh, rh = RH2M)
rh = rasterize(rh, raster_template, res=20)
ws = climate_vars_sf["WS10M"]
ws = dplyr::rename(ws, ws = WS10M)
ws = rasterize(ws, raster_template, res=20)
prec = climate_vars_sf["PRECTOTCORR"]
prec = dplyr::rename(prec, prec = PRECTOTCORR)
prec = rasterize(prec, raster_template, res=20)
stack = stack(temp, rh, ws, prec)
fwi_outputs_dfpipe = fwiRaster(stack)
```
