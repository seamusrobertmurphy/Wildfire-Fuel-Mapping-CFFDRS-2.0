---
title: "Proof of Concept:"
subtitle: "CFFDRS Wildfire Fuel Mapping Prototype"
author: "CabinGIS"
date: "24/02/2022"
output: 
  pdf_document:
    toc: TRUE
    toc_depth: 5
    number_sections: TRUE
    df_print: tibble
    citation_package: natbib
    latex_engine: xelatex
  zotero: TRUE
bibliography: references.bib
---

```{r setup, echo=FALSE, message=FALSE,warning=FALSE, error=FALSE}
library(lidR)
library(mapview)
library(rgl)
library(pandocfilters)
library(rmarkdown)
library(formatR)
library(gitignore)
library(tinytex)
library(knitr)
library(raster)
library(webdriver)
library(webshot)
library(webshot2)
library(RColorBrewer)
library(conflicted)
library(readr)
library(tibble)
library(sf)
library(dplyr)
library(raster)
library(terra)
library(rgdal)
library(cffdrs)
library(ncdf4)
library(elevatr)
library(ggplot2)
#webshot::install_phantomjs(force = TRUE)
knit_hooks$set(webgl = hook_webgl)
knit_hooks$set(rgl.static = hook_rgl)
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, error=FALSE, message = FALSE)
set.seed(23)
```

## Action {.unnumbered}

Building on the momentum and ideas of our last meeting, the following pipeline was attempted to produce the wildfire fuel mapping outputs described in the NRC grant "High-Resolution Mapping":

-   NRC Grant: <https://www.ic.gc.ca/eic/site/101.nsf/eng/00157.html>

Using the new [cffdrs R-package](https://cran.r-project.org/web/packages/cffdrs/cffdrs.pdf) (@wang2017cffdrs; @van1985equations; @van1987development), we developed rasters of forest fuel moisture code and wildfire weather indices (Table 1) that were used to fit the stand-adjusted fine-fuel model (@wotton2007stand) applied to vegetation rasters classified according to 16 fuel classes of the BC forest fuel typing algorithm ( @perrakis2018british). Resulting rasters were then used to fit the Canadian Forest Fire Behaviour Prediction model from which we drafted raster maps representing Head Fire Index (HFI) and Fire Intensity maps (FI) (Figure 1) for the Peachland watershed administration area on the day of June 30th 2021.

# ![](Data/CFFDRS%20Prototype.png)BC WildFire Fuel Typing VRI-Layer Algorithm

## Import Site Data

An area-of-interest polygon was adopted from the Peachland watershed administration boundary, which was downloaded using the ImapBC custom warehouse download tool. This outline was used to clip and reproject all other raster objects and output using the GeoBC accepted BCAlbers CRS (EPSG:3005) and ggplot functions seen below.

```{r}
watershed_bdrys = read_sf("./Data/BCGW_7113060B_1645786298548_3276/LWADM_WATMGMT_PREC_AREA_SVW/LWADM_PA_polygon.shp")
peachland = watershed_bdrys[watershed_bdrys$PRECNC_NAM == "Peachland", ]
st_crs(peachland) = "epsg:3005"
ggplot(peachland) + 
  geom_sf() + 
  coord_sf()
```

## Import Topographical Data

For testing purposes, we acquired open source LiDAR data using the 'elevatr' package to download the SRTM 3arc-seconds dataset (@van2001shuttle). To land the download, we generated a spatial data object from the peachland simple feature. All rasters were labelled to match those required by the fwiRaster and fpbRaster functions. The 3-arc second DEM was transformed into a spatRaster for speedier operations and disaggreated from 98m resolution to 32m\~ resolution. Slope and aspect rasters calculated using the terra::terrain function and clipped to the preachland watershed boundary.

```{r, fig.show='hold', out.width="33%"}
peachland_sp = as(peachland, "Spatial")
ELV = get_elev_raster(peachland_sp, z = 9)
ELV = rast(ELV)
ELV = disagg(ELV, fact=3.3)
crs(ELV) = "epsg:3005"
ELV = mask(ELV, vect(peachland_sp))
GS = terrain(ELV, "slope")
Aspect = terrain(ELV, "aspect")
GS = mask(GS, vect(peachland_sp))
Aspect = mask(Aspect, vect(peachland_sp))
plot(GS)
plot(ELV)
plot(Aspect)
```

## Import Climate Data

Climate variables were downloaded as NetCDF files from NASA Power platform and read directly into R as rasters of 1) mean daily temperature at 2m, 2) mean daily precipitation, 3) mean relative humidity, 4) and mean wind speed at 10m. The NASA Power platform supports some very user-friendly API links for static data sources that might be useful for this proposed grant project. REminder tho, some API's prefer dealing with dataframe inputs so might be worht preparing df pipe while still fresh in the head.

-   NASA Power Platform: <https://power.larc.nasa.gov/data-access-viewer/>

```{r, fig.show='hold', out.width="50%"}
temp = terra::rast("./Data/temp.nc")
prec = terra::rast("./Data/prec.nc")
rh = terra::rast("./Data/rh.nc")
ws = terra::rast("./Data/ws.nc")
temp = terra::resample(temp, ELV, method="bilinear")
prec = terra::resample(prec, ELV, method="bilinear")
rh = terra::resample(rh, ELV, method="bilinear")
ws = terra::resample(ws, ELV, method="bilinear")
temp = mask(temp, vect(peachland))
prec = mask(prec, vect(peachland))
rh = mask(rh, vect(peachland))
ws = mask(ws, vect(peachland))
temp = mean(temp)
prec = mean(prec)
rh = mean(rh)
ws = mean(ws)
names(temp) = 'temp'
names(prec) = 'prec'
names(rh) = 'rh'
names(ws) = 'ws'
plot(temp)
plot(prec)
plot(rh)
plot(ws)
```

## Derive CFFDRS Wildfire Weather Rasters

Interpolated climate predictors were assembled as a raster stack and inputted into the fwiRaster function. The 'out="all'" option was selectedin the fwiRaster function which gave us the additional raster outputs for Initial Spread Index (isi), and Build-up Index (bui).

```{r}
temp = raster::raster(temp)
prec = raster::raster(prec)
rh = raster::raster(rh)
ws = raster::raster(ws)
stack = stack(temp, rh, ws, prec)
fwi_outputs = fwiRaster(stack, out = "all")
plot(fwi_outputs)
ffmc = raster(fwi_outputs, layer=5)
dmc = raster(fwi_outputs, layer=6)
dc = raster(fwi_outputs, layer=7)
isi = raster(fwi_outputs, layer=8)
bui = raster(fwi_outputs, layer=9)
fwi = raster(fwi_outputs, layer=10)
dsr = raster(fwi_outputs, layer=11)
```

# Import VRI Data

We imported the VRI dataset from imapBC and imported as a shapefile.shp into R. The BRI object was transformed into a simple feature and processed using sf and dplyr functions. For an idea of CFFDRS data requirements, we've taken a look at the in-built sample datasets 'test_fwi' and 'test_fpb' below:

```{r}
library(cffdrs)
print(as_tibble(test_fwi), n = 10)
print(as_tibble(test_fbp), n = 10)
```

# Import VRI Data

```{r, fig.show='hold', out.width="50%"}
vri_sf = read_sf("./Data/BCGW_7113060B_1645786298548_3276/VEG_COMP_LYR_R1_POLY/VEG_R1_PLY_polygon.shp")
vri_sf = st_intersection(st_make_valid(vri_sf), peachland)
stand = vri_sf["SPEC_CD_1"] %>% mutate(SPEC_CD_1 = as.factor(SPEC_CD_1))
stand = rename(stand, stand = SPEC_CD_1)
summary.factor(stand$stand)
density = vri_sf["LIVE_STEMS"] %>% mutate(LIVE_STEMS = as.numeric(LIVE_STEMS))
density = rename(density, density = LIVE_STEMS)
summary(density)
ggplot(stand) + geom_sf(aes(fill=stand), size = 0.05)
ggplot(density) + geom_sf(aes(fill=density), size = 0.0005) + scale_fill_viridis_c()
```

```{r, eval=FALSE} 
plot(st_geometry(vri_sf))


# Queries
fields::stats(vri_sf$HRVSTDT) 
fields::stats(vri_sf$C_I_CODE) 
fields::stats(vri_sf$BEC_ZONE) 
fields::stats(vri_sf$BCLCS_LV_1)

psych::descri(vri_sf)

summary.factor(vri_sf\$SPEC_CD_1)

C1_fuel = vri_sf %>% dplyr::filter(BCLCS_LV_2 == 'V', BCLCS_LV_1 == 'V', HRVSTDT \> 19970000, HRVSTDT \> 20140000, BEC_ZONE == "BWBS" \| BEC_ZONE == "SWB", SPEC_CD_1 =='S' \| SPEC_CD_1 == 'SB' \| SPEC_CD_1 == 'SE' \| SPEC_CD_1 =='SX')

C2_fuel = vri_sf %>% dplyr::filter(BCLCS_LV_2 == 'V', BCLCS_LV_1 == 'V', HRVSTDT \> 19970000, HRVSTDT \> 20140000, BEC_ZONE == "BWBS" \| BEC_ZONE == "SWB", SPEC_CD_1 =='S' \| SPEC_CD_1 == 'SB' \| SPEC_CD_1 == 'SE' \| SPEC_CD_1 =='SX')

C3_fuel = vri_sf %>% dplyr::filter(BCLCS_LV_2 == 'V', BCLCS_LV_1 == 'V', HRVSTDT \> 19970000, HRVSTDT \> 20140000, SPEC_CD_1 =='Pl' \| SPEC_CD_1 == 'Pli' \| SPEC_CD_1 == 'Plc' \| SPEC_CD_1 =='Pj'\| SPEC_CD_1 == 'P' \| SPEC_CD_1 =='SE',)

C4_fuel = vri_sf %>% dplyr::filter(BCLCS_LV_2 == 'V', BCLCS_LV_1 == 'V', HRVSTDT \> 19970000, HRVSTDT \> 20140000, SPEC_CD_1 =='Pl' \| SPEC_CD_1 == 'Pli' \| SPEC_CD_1 == 'Plc' \| SPEC_CD_1 =='Pj'\| SPEC_CD_1 == 'P' \| SPEC_CD_1 =='SE',)

C4_fuel = vri_sf %>% dplyr::filter(BCLCS_LV_2 == 'V', BCLCS_LV_1 == 'V', HRVSTDT \> 19970000, HRVSTDT \> 20140000, SPEC_CD_1 =='Pl' \| SPEC_CD_1 == 'Pli' \| SPEC_CD_1 == 'Plc' \| SPEC_CD_1 =='Pj'\| SPEC_CD_1 == 'P', vri_sf\$PROJ_AGE_1 \< 2) \# Competitor Tools for Fuel Typing in BC 2022

#### *fwiRaster and sdmc calculated based on daily climate records*

#### *gfmc and hffmc calculated based on hourly climate records - key to CFFDRSv2.0*

#### *Start date of fire season calculated with fireSeason*

#### *All outputs generated for once-daily calcuylations for the full fireSeason chronologically using 'batch=TRUE' function*

```
